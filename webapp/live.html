<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>PocketSphinx.js</title>
  </head>
  <body>
    <h2>PocketSphinx.js live demo</h2>
    <ul>
      <li>This demo works on Chrome with the Web Audio API, make sure it works for you and actually records audio (audio recording on Chrome does not work well on all configs).</li>
      <li>Press "Start" and speak digits</li>
    </ul>

    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <span id="recording-indicator" style="border-radius: 10px; -moz-border-radius: 10px; -webkit-border-radius: 10px; width: 20px; height: 20px; background: red;"></span>
    <h2>Recognition Output</h2>
    <div id="output" style="height:150px;overflow:auto;" >
    </div>
    <h2>Status</h2>
    <div id="current-status">Loading page</div>

    <script>
      var recognizer = null;
      var recorder = null;
      function spawnWorker(workerurl, onReady) {
          var recognizerWorker = new Worker(workerurl);
          recognizerWorker.onmessage = function(event) {
            onReady(recognizerWorker);
          };
          recognizerWorker.postMessage();
      };

      function updateHyp(hyp) {
        output.innerHTML = hyp;
      };

      function updateStatus(newStatus) {
        document.getElementById('current-status').innerHTML += "<br/>" + newStatus;
      };

      function displayRecording(display) {
        if (display) document.getElementById('recording-indicator').innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
        else document.getElementById('recording-indicator').innerHTML = "";
      };

      var audio_context;
      function startUserMedia(stream) {
        var input = audio_context.createMediaStreamSource(stream);
        input.connect(audio_context.destination);
        recorder = new AudioRecorder(input);
        if (recognizer) recorder.recognizer = recognizer;
        startBtn.disabled = false;
        stopBtn.disabled = false;
        updateStatus("Audio recorder ready");
      }

      var startRecording = function() {
        if (recorder && recorder.start()) displayRecording(true);
      else console.log("Not starting");

      }
      var stopRecording = function() {
        recorder && recorder.stop();
        displayRecording(false);
      }

      var initRecognizer = function(worker) {
         worker.postMessage({ command: 'initialize' });
      };

      var feedRecognizer = function(worker) {
         worker.postMessage({ command: 'addWords', data: [["ONE", "W AH N"], ["TWO", "T UW"], ["THREE", "TH R IY"], ["FOUR", "F AO R"], ["FIVE", "F AY V"], ["SIX", "S IH K S"], ["SEVEN", "S EH V AH N"], ["EIGHT", "EY T"], ["NINE", "N AY N"], ["ZERO", "Z IH R OW"]]});
         var grammar = {numStates: 1, transitions: [{from: 0, to: 0, word: "ONE"},{from: 0, to: 0, word: "TWO"},{from: 0, to: 0, word: "THREE"},{from: 0, to: 0, word: "FOUR"},{from: 0, to: 0, word: "FIVE"},{from: 0, to: 0, word: "SIX"},{from: 0, to: 0, word: "SEVEN"},{from: 0, to: 0, word: "EIGHT"},{from: 0, to: 0, word: "NINE"},{from: 0, to: 0, word: "ZERO"}]};
         worker.postMessage({command: 'addGrammar', data: grammar});
      };

      window.onload = function init() {
        updateStatus("Initializing Web Audio and speech recognizer, waiting for approval to access your microphone");
        spawnWorker("js/recognizer.js", function(worker) {
            worker.onmessage = function(e) {
                if (e.data.hasOwnProperty('status') && e.data.hasOwnProperty('command')) {
                      if ((e.data.command == "initialize") && (e.data.status == "done")) {
                        updateStatus("Recognizer is ready");
                        recognizer = worker;
                        if (recorder) recorder.recognizer = recognizer;
                        feedRecognizer(worker);
                      }
                }
                if (e.data.hasOwnProperty('hyp')) {
                       updateHyp(e.data.hyp);
                }
            };
            initRecognizer(worker);
        });
        try {
          window.AudioContext = window.AudioContext || window.webkitAudioContext;
          navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
          window.URL = window.URL || window.webkitURL;
          audio_context = new AudioContext;
        } catch (e) {
          updateStatus("No web audio support in this browser");
          return;
        }
        navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
          updateStatus("No live audio input in this browser");
      });

      var startBtn = document.getElementById('startBtn');
      var stopBtn = document.getElementById('stopBtn');
      startBtn.disabled = true;
      stopBtn.disabled = true;
      startBtn.onclick = startRecording;
      stopBtn.onclick = stopRecording;
      };
    </script>
    <script src="js/audioRecorder.js"></script>
  </body>
</html>
