<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>PocketSphinx.js</title>
  </head>
  <body>
    <h2>PocketSphinx.js live demo</h2>
    <ul>
      <li>This demo works on Chrome with the Web Audio API, make sure it works for you and actually records audio (audio recording on Chrome does not work well on all configs).</li>
      <li>Press "Start" and speak digits</li>
    </ul>

    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <span id="recording-indicator" style="border-radius: 10px; -moz-border-radius: 10px; -webkit-border-radius: 10px; width: 20px; height: 20px; background: red;"></span>
    <h2>Recognition Output</h2>
    <div id="output" style="height:150px;overflow:auto;" >
    </div>
    <h2>Status</h2>
    <div id="current-status">Loading page</div>

    <script>
      function updateHyp(hyp) {
        output.innerHTML = hyp;
      };
      function updateStatus(newStatus) {
        document.getElementById('current-status').innerHTML += "<br/>" + newStatus;
      };
      function displayRecording(display) {
        if (display) document.getElementById('recording-indicator').innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
        else document.getElementById('recording-indicator').innerHTML = "";
      };
      var recognizerLoaderCallback;
      var recognizerLoader;
      var audio_context;
      function startUserMedia(stream) {
        var input = audio_context.createMediaStreamSource(stream);
        input.connect(audio_context.destination);
        recorder = new AudioRecorder(input);
        if (recognizer) recorder.recognizer = recognizer;
        startBtn.disabled = false;
        stopBtn.disabled = false;
        updateStatus("Audio recorder ready");
      }

      var startRecording = function() {
        if (recorder && recorder.start()) displayRecording(true);

      }
      var stopRecording = function() {
        recorder && recorder.stop();
        displayRecording(false);
      }

      window.onload = function init() {
        updateStatus("Initializing Web Audio and speech recognizer, waiting for approval to access your microphone");
        recognizerLoader.load(recognizerLoaderCallback, updateStatus);
        try {
          window.AudioContext = window.AudioContext || window.webkitAudioContext;
          navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
          window.URL = window.URL || window.webkitURL;
          audio_context = new AudioContext;
        } catch (e) {
          updateStatus("No web audio support in this browser");
          return;
        }
        navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
          updateStatus("No live audio input in this browser");
      });

      var startBtn = document.getElementById('startBtn');
      var stopBtn = document.getElementById('stopBtn');
      startBtn.disabled = true;
      stopBtn.disabled = true;
      startBtn.onclick = startRecording;
      stopBtn.onclick = stopRecording;

      };
    </script>
    <script src="js/audioRecorder.js"></script>
    <script src="js/recognizer.js"></script>
    <script>
      var recognizer;
      var recorder;
      recognizerLoader = new RecognizerLoader();
      recognizerLoaderCallback = function() {
            recognizer = new Recognizer();
            recognizer.initialize();
            recognizer.addWord("ONE", "W AH N");
            recognizer.addWord("TWO", "T UW");
            recognizer.addWord("THREE", "TH R IY");
            recognizer.addWord("FOUR", "F AO R");
            recognizer.addWord("FIVE", "F AY V");
            recognizer.addWord("SIX", "S IH K S");
            recognizer.addWord("SEVEN", "S EH V AH N");
            recognizer.addWord("EIGHT", "EY T");
            recognizer.addWord("NINE", "N AY N");
            recognizer.addWord("ZERO", "Z IH R OW");
            recognizer.startGrammar(1);
            recognizer.addTransition(0, 0, "ONE");
            recognizer.addTransition(0, 0, "TWO");
            recognizer.addTransition(0, 0, "THREE");
            recognizer.addTransition(0, 0, "FOUR");
            recognizer.addTransition(0, 0, "FIVE");
            recognizer.addTransition(0, 0, "SIX");
            recognizer.addTransition(0, 0, "SEVEN");
            recognizer.addTransition(0, 0, "EIGHT");
            recognizer.addTransition(0, 0, "NINE");
            recognizer.addTransition(0, 0, "ZERO");
            recognizer.endGrammar();
            if (recorder) recorder.recognizer = recognizer;
      };
    </script>
  </body>
</html>
